# FlashRates 架構與演算法說明

**版本：** 2.5  
**更新日期：** 2026-01-18

---

## 目錄

1. [系統架構總覽](#1-系統架構總覽)
2. [防過度抓取機制](#2-防過度抓取機制)
3. [數據正確性保障](#3-數據正確性保障)
4. [延遲計算優化](#4-延遲計算優化)
5. [時間戳準確性](#5-時間戳準確性)
6. [來源配置參考](#6-來源配置參考)

---

## 1. 系統架構總覽

```
┌─────────────────────────────────────────────────────────────────────┐
│                         FlashRates 系統架構                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │
│  │  Binance    │  │ GoldPrice   │  │    Sina     │  │   Yahoo    │  │
│  │  (PAXG)     │  │   .org      │  │  Finance    │  │  Finance   │  │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └─────┬──────┘  │
│         │                │                │               │         │
│  ┌──────▼────────────────▼────────────────▼───────────────▼──────┐  │
│  │                HTTP Client (共用 Session)                      │  │
│  │   • 連線池復用，減少 TCP 握手開銷                              │  │
│  │   • 自動重試 (Exponential Backoff)                            │  │
│  │   • 狀態碼 429/5xx 自動等待重試                               │  │
│  └────────────────────────────┬─────────────────────────────────┘  │
│                               ▼                                     │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                    Scheduler (排程器)                         │   │
│  │   • 時間分片輪詢 (Staggered Polling)                          │   │
│  │   • 各來源獨立間隔與偏移量 (Offset)                            │   │
│  │   • Circuit Breaker 熔斷檢查                                  │   │
│  └────────────────────────────┬─────────────────────────────────┘   │
│                               ▼                                     │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                    Aggregator (聚合引擎)                       │   │
│  │   • 加權平均計算 (權重依來源可信度)                            │   │
│  │   • 異常值過濾 (偏離中位數 > 0.3% 自動剔除)                   │   │
│  │   • 加權延遲計算 (只取前 5 快來源)                            │   │
│  └────────────────────────────┬─────────────────────────────────┘   │
│                               ▼                                     │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                       Redis / FakeRedis                       │   │
│  │   • PubSub: market:stream:{symbol}                           │   │
│  │   • Cache:  market:latest:{symbol}                           │   │
│  └──────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. 防過度抓取機制

### 2.1 時間分片輪詢 (Staggered Polling)

為避免同時請求造成 IP 封鎖，各來源按 **偏移量 (Offset)** 錯開啟動時間：

```python
# backend/scheduler.py 中的配置
SOURCE_CONFIG = {
    "Binance":           {"interval": 2,    "offset": 0},     # T+0.0s
    "Sina Finance":      {"interval": 5,    "offset": 0.5},   # T+0.5s
    "GoldPrice.org":     {"interval": 15,   "offset": 1},     # T+1.0s
    "BullionVault":      {"interval": 10,   "offset": 2},     # T+2.0s
    "OANDA":             {"interval": 5,    "offset": 3},     # T+3.0s
    "Yahoo Finance":     {"interval": 60,   "offset": 5},     # T+5.0s
    "Kitco":             {"interval": 60,   "offset": 10},    # T+10.0s
    "exchangerate.host": {"interval": 30,   "offset": 12},    # T+12.0s
    "Taiwan Bank":       {"interval": 60,   "offset": 20},    # T+20.0s
    "open.er-api.com":   {"interval": 60,   "offset": 25},    # T+25.0s
    "Fawaz API":         {"interval": 3600, "offset": 30},    # 每小時 (CDN)
    "FloatRates":        {"interval": 3600, "offset": 45},    # 每小時 (每日更新)
    "Investing.com":     {"interval": 120,  "offset": 15},    # 2分鐘 (Cloudflare)
}
```

**效果：** 請求被分散到不同時間點，避免伺服器偵測到高頻請求模式。

### 2.2 HTTP 請求重試與指數退避 (Exponential Backoff)

```python
# backend/http_client.py
async def _request_with_retries(..., retries=2, backoff=0.5):
    for attempt in range(retries + 1):
        try:
            async with session.request(...) as response:
                # 遇到 429 (Rate Limit) 或 5xx 錯誤時自動等待重試
                if status in {429, 500, 502, 503, 504} and attempt < retries:
                    await asyncio.sleep(backoff * (2 ** attempt))  # 0.5s -> 1s -> 2s
                    continue
                return status, data
        except (aiohttp.ClientError, asyncio.TimeoutError):
            await asyncio.sleep(backoff * (2 ** attempt))
            continue
```

**效果：** 遇到暫時性錯誤時，系統會指數級增加等待時間後重試，而非立即重試造成更大壓力。

### 2.3 熔斷器 (Circuit Breaker)

```python
# backend/circuit_breaker.py
class CircuitBreaker:
    def __init__(self, failure_threshold=3, recovery_timeout=60):
        self.failure_threshold = failure_threshold  # 連續失敗 3 次後熔斷
        self.recovery_timeout = recovery_timeout    # 60 秒後進入半開狀態

    def record_failure(self, source_name):
        self.failures[source_name] += 1
        if self.failures[source_name] >= self.failure_threshold:
            logger.warning(f"Circuit Breaker: OPEN for {source_name}")
            self.open_circuits.add(source_name)  # 停止請求該來源

    def is_available(self, source_name) -> bool:
        if source_name not in self.open_circuits:
            return True
        # 超過恢復時間後進入 HALF-OPEN 狀態，允許一次試探請求
        if time.time() - self.last_failure_time[source_name] > self.recovery_timeout:
            logger.info(f"Circuit Breaker: HALF-OPEN for {source_name}")
            return True
        return False
```

**效果：** 當某來源連續失敗 3 次後，系統會**暫停對該來源的請求 60 秒**，避免持續發送無效請求被封鎖。

### 2.4 共用 HTTP Session

```python
# backend/http_client.py
_session: Optional[aiohttp.ClientSession] = None

async def get_session() -> aiohttp.ClientSession:
    global _session
    if _session and not _session.closed:
        return _session
    _session = aiohttp.ClientSession()  # 所有請求共用一個 Session
    return _session
```

**效果：** 復用 TCP 連線池，減少 DNS 查詢和握手開銷，同時避免短時間內建立過多連線被偵測。

### 2.5 自適應輪詢 (Adaptive Polling)

當來源連續失敗或回傳空資料時，系統會**自動放慢**該來源輪詢節奏；當來源恢復穩定，逐步回到基準頻率。

```python
# backend/scheduler.py (簡化)
if result:
    scale = max(1.0, scale * 0.9)  # 成功逐步回到基準
else:
    scale = min(4.0, scale * 1.5)  # 失敗放慢，降低封鎖風險

await asyncio.sleep(base_interval * scale)
```

**效果：**

- 失敗來源自動降頻，降低封鎖風險
- 穩定來源保持接近即時的更新

---

## 3. 數據正確性保障

### 3.1 異常值過濾 (Outlier Filtering)

```python
# backend/aggregator.py
if len(prices) >= 3:
    median = statistics.median(prices)
    # 過濾偏離中位數 > 0.3% 的異常值
    filtered_entries = [
        e for e in valid_entries
        if abs(e['price'] - median) / median < 0.003  # 0.3%
    ]

    if not filtered_entries:
        # 如果全都被過濾，使用中位數作為最終價格
        final_price = median
        logger.warning(f"{symbol}: All prices filtered as outliers, using median")
    else:
        # 使用過濾後的數據計算加權平均
        final_price = sum(e['price'] * e['weight'] for e in filtered_entries) / total_weight
```

**效果：** 當某來源回傳明顯錯誤的價格時（如網頁解析錯誤），該數據會被自動剔除，不影響最終結果。

### 3.2 加權平均計算 (Weighted Average)

每個來源根據其**可信度**被分配不同權重：

| 來源              | 權重 | 理由                       |
| ----------------- | ---- | -------------------------- |
| Binance           | 0.8  | 專業交易所 API，數據極可靠 |
| OANDA             | 0.8  | 專業外匯平台               |
| Taiwan Bank       | 0.7  | 官方牌告來源               |
| BullionVault      | 0.7  | 官方 XML API               |
| GoldPrice.org     | 0.6  | 穩定的公開來源             |
| Sina Finance      | 0.6  | 亞洲快速來源               |
| Yahoo Finance     | 0.5  | 延遲稍高但穩定             |
| Investing.com     | 0.5  | 需繞過防護                 |
| exchangerate.host | 0.5  | 免費匯率 API               |
| open.er-api.com   | 0.5  | 免費匯率 API               |
| Kitco             | 0.4  | HTML 爬蟲，較不穩定        |
| FloatRates        | 0.4  | 每日更新，非即時           |
| Mock              | 0.3  | 僅測試用                   |

```python
# 加權平均計算
total_weight = sum(e['weight'] for e in filtered_entries)
final_price = sum(e['price'] * e['weight'] for e in filtered_entries) / total_weight
```

**效果：** 高可信來源對最終價格的影響力更大，低可信來源僅作為補充參考。

### 3.3 新鮮度衰減與過期淘汰

為確保「1 秒聚合」不被舊資料拖慢，系統對來源資料加入新鮮度衰減與過期淘汰：

```python
# backend/aggregator.py (簡化)
if age > max_age:
    continue  # 直接淘汰過期資料

freshness = exp(-age / (max_age / 2))
eff_weight = weight * freshness
```

**效果：**

- 過期資料不進入聚合
- 越接近過期的來源權重越低

---

## 4. 延遲計算優化

### 4.1 問題：簡單平均被慢速來源拉高

**舊邏輯 (已棄用)：**

```python
avg_latency = statistics.mean([e['latency'] for e in valid_entries])
# 如果有一個 Investing.com 需要 10 秒，平均值會被嚴重拉高
```

### 4.2 解決方案：加權延遲 + 取前 N 快

**新邏輯：**

```python
# backend/aggregator.py

# 1. 找出最快來源的延遲 (真實即時性指標)
fastest_entry = min(valid_entries, key=lambda x: x['latency'])
fastest_latency = fastest_entry['latency']

# 2. 計算加權延遲，只取前 5 快的來源，排除極端慢速來源
sorted_entries = sorted(valid_entries, key=lambda x: x['latency'])
top_entries = sorted_entries[:min(5, len(sorted_entries))]

total_weight = sum(e['weight'] for e in top_entries)
weighted_latency = sum(e['latency'] * e['weight'] for e in top_entries) / total_weight
```

**效果：**

- `fastestLatency`：顯示最快來源的真實延遲，代表系統的**即時性能力**
- `avgLatency`：加權平均延遲（排除極端慢速來源），代表**穩定來源的平均表現**

---

## 5. 時間戳準確性

### 5.1 「上次更新」顯示最新數據時間

```python
# backend/aggregator.py

# 使用最新來源時間作為聚合時間 (確保「上次更新」準確)
source_timestamps = [e.get('timestamp') for e in valid_entries if e.get('timestamp')]
latest_source_ts = max(source_timestamps) if source_timestamps else None

output = {
    "timestamp": latest_source_ts or time.time(),  # 優先使用來源時間
    ...
}
```

**效果：** 前端顯示的「上次更新：X 毫秒前」反映的是**最新一筆數據的抓取時間**，而非聚合處理時間。

### 5.2 前端顯示邏輯

```jsx
// frontend/src/App.jsx
const baseMs = timestamp ? timestamp * 1000 : null;
const lastUpdateMs = baseMs ? Math.max(0, Math.floor(now - baseMs)) : null;

// 顯示：上次更新：XXX 毫秒前
<span>{lastUpdateMs !== null ? lastUpdateMs : "--"}</span> 毫秒前
```

---

## 6. 來源配置參考

### 6.1 完整來源列表 (14 個)

| #   | 來源              | 類型       | 間隔  | 偏移 | 權重 | 支援資產          |
| --- | ----------------- | ---------- | ----- | ---- | ---- | ----------------- |
| 1   | Binance           | Crypto API | 2s    | 0s   | 0.8  | XAU               |
| 2   | GoldPrice.org     | JSON API   | 15s   | 1s   | 0.6  | XAU, XAG          |
| 3   | Sina Finance      | HTTP       | 5s    | 0.5s | 0.6  | XAU, XAG, USD-TWD |
| 4   | BullionVault      | XML API    | 10s   | 2s   | 0.7  | XAU               |
| 5   | Yahoo Finance     | REST API   | 60s   | 5s   | 0.5  | XAU, XAG, USD-TWD |
| 6   | Kitco             | HTML 爬蟲  | 60s   | 10s  | 0.4  | XAU, XAG          |
| 7   | Investing.com     | Playwright | 120s  | 15s  | 0.5  | XAU, XAG, USD-TWD |
| 8   | OANDA             | REST API   | 5s    | 3s   | 0.8  | XAU, XAG, USD-TWD |
| 9   | Taiwan Bank       | CSV        | 60s   | 20s  | 0.7  | USD-TWD           |
| 10  | exchangerate.host | REST API   | 30s   | 12s  | 0.5  | USD-TWD           |
| 11  | open.er-api.com   | REST API   | 60s   | 25s  | 0.5  | USD-TWD           |
| 12  | Fawaz API         | CDN        | 3600s | 30s  | 0.5  | USD-TWD           |
| 13  | FloatRates        | JSON Feed  | 3600s | 45s  | 0.4  | USD-TWD           |
| 14  | Mock              | 測試       | 2s    | 0s   | 0.3  | 全部              |

### 6.3 來源級 max_age 參數表

> 說明：`max_age` 為單一來源資料允許的最大時效（秒），超過即淘汰。

| 來源              | interval | max_age | 說明            |
| ----------------- | -------- | ------- | --------------- |
| Binance           | 2s       | 6s      | 取 3 倍基準間隔 |
| GoldPrice.org     | 15s      | 45s     | 取 3 倍基準間隔 |
| Sina Finance      | 5s       | 15s     | 取 3 倍基準間隔 |
| BullionVault      | 10s      | 30s     | 取 3 倍基準間隔 |
| Yahoo Finance     | 60s      | 180s    | 取 3 倍基準間隔 |
| Kitco             | 60s      | 180s    | 取 3 倍基準間隔 |
| Investing.com     | 120s     | 360s    | 取 3 倍基準間隔 |
| OANDA             | 5s       | 15s     | 取 3 倍基準間隔 |
| Taiwan Bank       | 60s      | 180s    | 取 3 倍基準間隔 |
| exchangerate.host | 30s      | 90s     | 取 3 倍基準間隔 |
| open.er-api.com   | 60s      | 180s    | 取 3 倍基準間隔 |
| Fawaz API         | 3600s    | 10800s  | 取 3 倍基準間隔 |
| FloatRates        | 3600s    | 10800s  | 取 3 倍基準間隔 |
| Mock              | 2s       | 6s      | 取 3 倍基準間隔 |

### 6.2 配置修改方式

若需調整來源配置，請編輯 `backend/scheduler.py` 中的 `SOURCE_CONFIG`。

---

## 變更紀錄

| 版本 | 日期       | 說明                                             |
| ---- | ---------- | ------------------------------------------------ |
| v2.5 | 2026-01-18 | 新增自適應輪詢、新鮮度衰減、max_age 參數表       |
| v2.4 | 2026-01-18 | 新增加權延遲計算、修復時間戳準確性、新增完整文檔 |
| v2.3 | 2026-01-17 | 新增 Fawaz API、FloatRates 來源                  |
| v2.0 | 2026-01-17 | 完整實作 8 源聚合系統                            |

---

_本文檔由 FlashRates 開發團隊維護_
