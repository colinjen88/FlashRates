# **高頻匯率數據聚合系統 v2.0 (High-Frequency Market Data Aggregator)**

**文件版本：** 2.0

**更新日期：** 2026-01
**目標：** 實現低於 1 秒更新頻率的黃金、白銀及法幣匯率聚合數據流。

## **1\. 系統架構設計 (System Architecture)**

本系統採用「分散式採集、中心化聚合」模式。針對單一來源頻率限制與封鎖風險，採用 **「多源交錯輪詢 (Staggered Polling)」** 與 **「異構數據源混合 (Heterogeneous Source Mixing)」** 策略。

### **1.1 核心邏輯**

* **時間分片 (Time Slicing)：** 將 1 秒的時間窗口切分為多個 Slot，不同來源在不同微秒啟動請求，填補時間空隙。  
* **多資產並行 (Multi-Asset Parallelism)：** 黃金 (XAU)、白銀 (XAG)、美元匯率 (USD/TWD) 由獨立的 Worker Pool 平行處理，互不阻塞。  
* **異常熔斷 (Circuit Breaker)：** 當某來源延遲超過 800ms 或價格偏離中位數 \> 0.3% 時，自動降權或暫時剔除。

## **2\. 數據源擴充策略 (Data Source Expansion)**

為了確保 100% 的可用性並規避反爬蟲機制，系統將數據源由原本的 4 組擴充至 **8 組**，涵蓋 HTML 爬蟲、API、WebSocket 及區塊鏈預言機。

| 類型 | 來源名稱 | 特性與用途 | 更新頻率策略 |
| :---- | :---- | :---- | :---- |
| **Direct** | **BullionVault** | XML 接口，穩定性高，作為基準數據。 | 每 5-10 秒 |
| **Scrape** | **Investing.com** | 數據最全，但需繞過 Cloudflare (Playwright)。 | 每 15-20 秒 |
| **Legacy** | **Kitco** | 傳統 HTML 解析，備援用。 | 每 30 秒 |
| **API** | **Yahoo Finance** | yfinance 庫，延遲稍高但極不易封鎖。 | 每 60 秒 |
| **Crypto** | **Binance (PAXG)** | **(新增)** 錨定金幣 PAXG/USDT，API 開放且極快 ( \<100ms )。 | **每 0.5 秒** |
| **Scrape** | **GoldPrice.org** | **(新增)** 老牌網站，結構簡單解析快。 | 每 10 秒 |
| **Http** | **Sina Finance** | **(新增)** 新浪財經，亞洲伺服器響應快，適合亞洲時段。 | 每 3 秒 |
| **Stream** | **OANDA (Demo)** | **(新增)** 模擬倉 API，提供正規 WebSocket 串流。 | **實時推送** |

## **3\. 前端介面實作概覽 (Frontend Implementation Overview)**

前端採用現代化 Single Page Application (SPA) 架構，強調數據的可視化與操作的即時性。

### **3.1 技術棧**

* **框架：** React.js / Next.js  
* **樣式：** Tailwind CSS (深色金融風格)  
* **圖標：** Lucide React

### **3.2 核心功能模組 (已實作原型)**

1. **多資產即時看板 (Multi-Asset Ticker)：**  
   * 採用 **3 欄式 Grid 佈局**，同步顯示 黃金 (XAU)、白銀 (XAG) 與 美金匯率 (USD/TWD)。  
   * **視覺補間 (Visual Interpolation)：** 價格變動時背景與文字出現 綠色/紅色 閃爍動畫，並顯示漲跌幅百分比。  
   * **壓縮版面設計：** 優化 Header 高度，讓核心數據在首屏 (Above the fold) 即可見，符合交易員監控需求。  
2. **動態聚合狀態可視化：**  
   * 顯示當前活躍的數據源數量 (例如 "8/8 Sources Active")。  
   * 下方具備微型進度條與來源名稱，實時展示當前價格是由哪一個來源貢獻的（來源歸因）。  
3. **整合式開發者文檔 (Interactive API Docs)：**  
   * 內嵌於儀表板的 API 說明頁面。  
   * 提供 cURL, Python, JavaScript 的一鍵複製代碼範例。  
   * 支援參數說明：如 symbols=xau-usd,xag-usd 的批量請求方式。

## **4\. 後端技術規格 (Backend Specifications)**

**建議技術棧：** Python (FastAPI) 或 Node.js (NestJS) \+ Redis \+ BullMQ

### **4.1 數據緩存層 (Redis Schema)**

使用 Redis Hash 儲存最新報價，確保讀取延遲 \< 5ms。

\# Key: market:latest:xau-usd  
{  
  "price": "2650.50",  
  "source": "Binance",  
  "timestamp": "1710000123456",  
  "confidence": "0.99"  
}

### **4.2 調度器邏輯 (The Scheduler)**

* 啟動時為每個來源分配 offset (時間偏移量)。  
* **Binance & OANDA** 設為高頻基準（High Frequency）。  
* **Scrapers (Investing, Kitco)** 設為低頻輪詢（Low Frequency），僅用於校正價格偏差。

## **5\. 給 AI 工程師的開發指令 (Dev Prompts Update)**

若您要請 AI 繼續開發，請使用以下精確指令：

### **階段一：擴充數據源**

"請幫我新增 fetch\_binance\_paxg() 與 fetch\_sina\_finance() 兩個 Python 異步函數。Binance 部分請使用 ccxt 庫或直接請求其 REST API 獲取 PAXG/USDT 價格；新浪財經請請求 hq.sinajs.cn 接口並解析 CSV 格式響應。請注意錯誤處理與 Timeout 設定。"

### **階段二：並行聚合優化**

"修改現有的聚合邏輯，支援 asyncio.gather 並行處理 XAU, XAG, USD-TWD 三種資產。請確保如果黃金的爬蟲卡住，不會影響白銀與匯率的數據更新。請實作一個 '權重計算器'，Binance 來源權重設為 0.8，傳統爬蟲設為 0.4，最終價格取加權平均。"

## **6\. 運維與風險控制**

1. **IP 代理池 (Proxy Pool)：** 針對 Investing.com 與 GoldPrice.org，必須強制走輪替代理。  
2. **法幣備案：** 若 Yahoo Finance 的 USD/TWD 失效，建議串接台灣銀行或富邦銀行的公開匯率牌告網頁作為備援。  
3. **瀏覽器指紋：** 使用 Playwright 時需掛載 playwright-stealth 插件。

**【補充】**

這是一份針對 **BullionVault** 與 **Investing.com** 的逆向工程技術筆記與開發指令。您可以直接將這些內容丟給您的 AI 工程師（例如 Cursor, ChatGPT, 或 Trae），讓它產出可運行的 Python 代碼。

### ---

**第一部分：BullionVault (難度：低)**

BullionVault 提供了一個相對公開的 XML 接口供其合作夥伴與舊版 App 使用，這比爬網頁 HTML 快得多，且不易被封鎖。

#### **1\. 技術分析 (Technical Analysis)**

* **Target URL:** https://live.bullionvault.com/secure/api/v2/view\_market\_xml.do  
* **Method:** HTTP GET  
* **Data Format:** XML  
* **關鍵結構:**  
  * 根節點 \<marketHeader\>  
  * 我們關注 \<pitch\> 節點，屬性 securityClass="McAgAu" (Au代表金) 和 currency="USD"。  
  * 價格位於 buyPrice (買入價) 與 sellPrice (賣出價)，通常取平均值或 sellPrice 作為現價。

#### **2\. 給 AI 的開發指令 (Prompt for BullionVault)**

請複製以下指令給您的 AI：

**角色設定：** 你是一個資深的 Python 爬蟲工程師。

**任務：**

請幫我寫一個 Python 腳本，用於抓取 **BullionVault** 的即時黃金價格。

**技術要求：**

4. 使用 requests 庫請求 URL: https://live.bullionvault.com/secure/api/v2/view\_market\_xml.do  
5. 解析回傳的 XML 數據。  
6. 找到 \<pitch\> 標籤，篩選條件為 securityClass="McAgAu" (黃金) 且 currency="USD"。  
7. 提取 sellPrice 屬性作為當前金價。  
8. 將結果整理成 JSON 格式：{'source': 'bullionvault', 'price': 2650.50, 'timestamp': 1712345678}。  
9. 添加 User-Agent header 偽裝成瀏覽器，並加入異常處理（Try-Except），如果請求失敗回傳 None。

### ---

**第二部分：Investing.com (難度：高)**

Investing.com 有嚴格的 Cloudflare 防護與動態渲染。單純用 requests 很容易遇到 403 Forbidden。最穩定的方式是用 **Playwright** (無頭瀏覽器) 模擬真實用戶。

#### **1\. 技術分析 (Technical Analysis)**

2. **Target URL:** https://www.investing.com/currencies/xau-usd  
3. **Method:** Headless Browser (Playwright / Selenium)  
4. **防護機制:** Cloudflare \+ JavaScript 渲染  
5. **關鍵選擇器 (CSS Selectors):**  
   * 價格通常位於具有 data-test="instrument-price-last" 屬性的元素中。  
   * 或者尋找 class 為 text-5xl/9 font-bold text-\[\#232526\] ... 的動態 class（Investing.com 常改版，建議用 data-test 屬性定位較穩）。

#### **2\. 給 AI 的開發指令 (Prompt for Investing)**

請複製以下指令給您的 AI：

**角色設定：** 你是一個擅長繞過 WAF 的 Python 爬蟲工程師。

**任務：**

請幫我寫一個使用 **Playwright** (Python版) 的腳本，抓取 **Investing.com** 的黃金現價 (XAU/USD)。

**技術要求：**

2. 使用 playwright.sync\_api 啟動 Chromium 瀏覽器（Headless 模式設為 True，但需注入 stealth 腳本以防被偵測）。  
3. 目標網址：https://www.investing.com/currencies/xau-usd  
4. 等待頁面加載完成，特別是價格元素。  
5. 使用 CSS Selector 定位價格：優先嘗試 \[data-test="instrument-price-last"\]，如果找不到則嘗試查找包含 "XAU/USD" 標題附近的價格數值。  
6. 提取文字內容，移除 "," (逗號) 並轉為 float。  
7. 回傳 JSON 格式：{'source': 'investing', 'price': 2650.50, 'timestamp': 1712345678}。  
8. **重要：** 程式碼需包含隨機 User-Agent 設定，並且在抓取失敗時能截圖報錯 (save debug screenshot)。

### ---

**第三部分：整合測試與調度 (The Gluer)**

當 AI 完成上述兩個腳本後，您需要一個「主程式」來進行時間分片（Time Slicing）。

#### **給 AI 的整合指令 (Prompt for Integration)**

**任務：**

我現在有兩個抓取函數：fetch\_bullionvault() 和 fetch\_investing()。

請幫我寫一個 **異步 (Asyncio)** 的主程式來調度它們：

* 建立一個 async loop。  
* 設定 **BullionVault** 每 10 秒執行一次。  
* 設定 **Investing** 每 10 秒執行一次。  
* **關鍵邏輯：** 讓 Investing 的啟動時間比 BullionVault 晚 5 秒（Offset \= 5s）。  
  * 0s: 啟動 BullionVault 任務  
  * 5s: 啟動 Investing 任務  
  * 10s: BullionVault 再次執行...  
* 將抓取到的價格打印在 Console 上，格式：\[時間\] \[來源\] 價格: 2xxx.xx。

### ---

